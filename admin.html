<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>إدارة شركة احمد فوزي حسن</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/compressorjs/1.2.1/compressor.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/vanilla-tilt/1.8.1/vanilla-tilt.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        body { font-family: 'Cairo', sans-serif; background: #f0f9ff; color: #1e3a8a; }
        .glass-card { background: white; border: 2px solid #FFD700; box-shadow: 0 10px 25px rgba(0,0,0,0.05); }
        .tab-btn { color: #64748b; border-bottom: 3px solid transparent; transition: 0.3s; }
        .tab-active { background-color: #f0f9ff !important; color: #DAA520 !important; border-bottom: 3px solid #DAA520; }
        input, select, textarea { background: #ffffff !important; border: 1px solid #bae6fd !important; width: 100%; padding: 12px; border-radius: 12px; outline: none; margin-bottom: 10px; }
        .gold-bg { background: linear-gradient(to right, #FFD700, #DAA520); color: #1e3a8a; }
        .red-bg { background: #ea0038; color: white; }
        .hidden-tab { display: none; }
        .preview-container { position: relative; aspect-ratio: 1/1; border-radius: 10px; border: 1px solid #FFD700; overflow: hidden; }
        .delete-preview { position: absolute; top: 4px; right: 4px; background: #ea0038; color: white; width: 20px; height: 20px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 10px; cursor: pointer; }
        
        .account-table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 13px; }
        .account-table th { background: #1e3a8a; color: white; padding: 10px; border: 1px solid #ddd; }
        .account-table td { padding: 8px; border: 1px solid #ddd; text-align: center; font-weight: bold; }
        .total-row { background: #f8fafc; color: #1e3a8a; }
        .final-balance { background: #22c55e !important; color: white !important; }
    </style>
</head>
<body class="min-h-screen flex items-start justify-center p-4">

    <div id="admin-panel" class="w-full max-w-2xl flex flex-col gap-6 py-4">
        <div class="flex justify-between items-center px-4 glass-card p-4 rounded-2xl" data-tilt>
            <div class="flex items-center gap-4">
                <img src="https://f.top4top.io/p_36418598n1.png" class="w-12 h-12">
                <div>
                    <h1 class="text-sm font-bold text-sky-900">الإدارة - احمد فوزي حسن</h1>
                    <span class="text-xs text-green-600 font-bold">● متصل (تخزين محلي)</span>
                </div>
            </div>
            </div>

        <div class="bg-white p-1 rounded-2xl flex gap-1 border border-sky-100 overflow-x-auto">
            <button onclick="btnFlip(this); switchTab('accounts')" id="tab-accounts" class="tab-btn flex-1 py-3 px-4 rounded-xl font-bold tab-active">إدارة الحسابات</button>
            <button onclick="btnFlip(this); switchTab('users')" id="tab-users" class="tab-btn flex-1 py-3 px-4 rounded-xl font-bold">إدارة المستخدمين</button>
            <button onclick="btnFlip(this); switchTab('cars')" id="tab-cars" class="tab-btn flex-1 py-3 px-4 rounded-xl font-bold">إدارة السيارات</button>
        </div>

        <div id="content-accounts" class="glass-card rounded-[2rem] p-6">
            <h2 class="text-center text-sky-800 mb-6 font-bold text-lg">كشف حساب المستخدم</h2>
            
            <div class="bg-blue-50 p-4 rounded-2xl mb-6 border border-blue-100">
                <select id="acc-user-select" class="mb-2" onchange="fetchAccountStatement()"><option value="">اختر المستخدم لعرض كشفه</option></select>
                <input type="text" id="acc-desc" placeholder="التفاصيل (مثلاً: واصل كاش، تصميم موقع...)">
                <div class="grid grid-cols-2 gap-3">
                    <input type="number" id="acc-for" placeholder="له (المبلغ الواصل)">
                    <input type="number" id="acc-against" placeholder="عليه (المبلغ المطلوب)">
                </div>
                <button onclick="addTransaction()" class="w-full gold-bg font-bold py-3 rounded-xl mt-2 shadow-md">إضافة العملية للكشف</button>
            </div>

            <div class="overflow-x-auto">
                <table class="account-table">
                    <thead>
                        <tr>
                            <th>التاريخ</th>
                            <th>التفاصيل</th>
                            <th>عليه</th>
                            <th>له</th>
                            <th>الرصيد</th>
                        </tr>
                    </thead>
                    <tbody id="statement-body"></tbody>
                    <tfoot>
                        <tr class="total-row font-bold">
                            <td colspan="2">إجمالي العمليات</td>
                            <td id="total-against" class="text-red-600">0</td>
                            <td id="total-for" class="text-green-600">0</td>
                            <td>-</td>
                        </tr>
                        <tr class="final-balance font-bold">
                            <td colspan="4" class="text-right px-4">الرصيد الإجمالي الحالي</td>
                            <td id="net-balance">0</td>
                        </tr>
                    </tfoot>
                </table>
            </div>
            <button onclick="clearUserAccount()" class="text-xs text-red-500 mt-4 w-full text-center underline">تصفية وحذف سجل هذا المستخدم</button>
        </div>

        <div id="content-users" class="glass-card rounded-[2rem] p-8 hidden-tab">
            <h2 class="text-center text-sky-800 mb-6 font-bold">إضافة مستخدم جديد</h2>
            <input type="text" id="new-username" placeholder="اسم المستخدم الجديد">
            <input type="password" id="new-password" placeholder="كلمة المرور (اختياري)">
            <button onclick="btnFlip(this); saveUser()" class="gold-bg font-bold py-4 rounded-xl w-full">إنشاء الحساب</button>
            
            <div class="mt-6 border-t pt-4">
                <h3 class="font-bold text-sm mb-2">المستخدمون الحاليون:</h3>
                <div id="users-list-display" class="grid grid-cols-2 gap-2 text-xs"></div>
            </div>
        </div>

        <div id="content-cars" class="glass-card rounded-[2rem] p-8 hidden-tab">
            <h2 class="text-center text-sky-800 mb-6 font-bold">إدارة سيارات المستخدم</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
                <select id="car-user-select" class="md:col-span-2" onchange="renderUserCarsGrid(this.value)"><option value="">اختيار المستخدم</option></select>
                <button onclick="btnFlip(this); openAddCarMode()" class="gold-bg font-bold py-3 rounded-xl md:col-span-2">+ إضافة سيارة جديدة لهذا المستخدم</button>
                <div class="md:col-span-2 mt-2">
                    <div class="font-bold text-sky-900 mb-2">سيارات المستخدم</div>
                    <div id="user-cars-grid" class="grid grid-cols-1 md:grid-cols-2 gap-3"><div class="text-gray-500 italic">اختر مستخدم حتى تظهر سياراته</div></div>
                </div>
            </div>

            <div id="car-form-box" class="mt-6 border border-sky-100 rounded-2xl p-4 bg-sky-50 hidden">
                <div class="flex items-center justify-between mb-2">
                    <div id="car-form-title" class="font-bold text-sky-900">إضافة سيارة جديدة</div>
                    <button onclick="closeCarForm()" class="text-red-600 font-bold text-sm">إغلاق</button>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
                    <input type="text" id="car-name" placeholder="اسم السيارة (يظهر للمستخدم)">
                    <input type="text" id="car-type" placeholder="نوع السيارة">
                    <input type="text" id="car-model" placeholder="موديل السيارة">
                    <input type="text" id="car-chassis" placeholder="رقم الشاصي">
                    <input type="text" id="car-container" placeholder="رقم الحاوية">
                    <input type="text" id="car-lot" placeholder="رقم اللوت">
                    <input type="text" id="car-facade" placeholder="واجهة السيارة">
                    <input type="date" id="car-arrival">
                    <textarea id="car-shipping" placeholder="تفاصيل الشحن" class="md:col-span-2" rows="3"></textarea>
                    <input type="text" id="car-notes" placeholder="ملاحظات" class="md:col-span-2">
                    <input type="file" id="car-photos" multiple accept="image/*" onchange="handleFileSelect(event)" class="md:col-span-2">
                    <div id="image-previews" class="grid grid-cols-3 gap-3 md:col-span-2"></div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-2 mt-3">
                    <button id="save-car-btn" onclick="btnFlip(this); saveCarWithPhotos()" class="gold-bg font-bold py-3 rounded-xl md:col-span-2">حفظ</button>
                    <button id="delete-car-btn" onclick="btnFlip(this); deleteCurrentCar()" class="red-bg font-bold py-3 rounded-xl hidden">حذف السيارة</button>
                </div>
            </div>
        </div>

        <div class="glass-card rounded-[2rem] p-6 mb-10 text-center">
            <h3 id="summary-title" class="font-bold mb-4 text-sky-900">معلومات التخزين</h3>
            <div class="text-sm text-gray-500">يتم حفظ البيانات تلقائياً على هذا الجهاز.</div>
            <button onclick="resetAllData()" class="mt-2 text-xs text-red-400 underline">حذف جميع البيانات (تهيئة)</button>
        </div>
    </div>

    <script>
        // --- تهيئة المكتبات والإعدادات ---
        let selectedImagesBase64 = [];
        window.editingCarId = null;
        VanillaTilt.init(document.querySelectorAll("[data-tilt]"), { max: 5 });
        window.btnFlip = (el) => gsap.to(el, { duration: 0.5, rotationY: 360 });

        // --- دوال التعامل مع التخزين المحلي (LocalStorage) ---
        const DB_KEYS = {
            USERS: 'afh_users',
            ACCOUNTS: 'afh_accounts',
            CARS: 'afh_cars'
        };

        function getDB(key) {
            const data = localStorage.getItem(key);
            return data ? JSON.parse(data) : [];
        }

        function setDB(key, data) {
            localStorage.setItem(key, JSON.stringify(data));
        }

        // --- التنقل بين التبويبات ---
        window.switchTab = (tab) => {
            ['content-accounts', 'content-users', 'content-cars'].forEach(id => document.getElementById(id).classList.add('hidden-tab'));
            document.getElementById('content-' + tab).classList.remove('hidden-tab');
            ['accounts','users','cars'].forEach(t => document.getElementById('tab-' + t).classList.remove('tab-active'));
            document.getElementById('tab-' + tab).classList.add('tab-active');
            if(tab === 'users') renderUsersList();
        };

        // --- تحميل البيانات الأولية ---
        function loadInitialData() {
            populateUserDropdowns();
            renderUsersList();
        }

        function populateUserDropdowns() {
            const users = getDB(DB_KEYS.USERS);
            const carS = document.getElementById('car-user-select');
            const accS = document.getElementById('acc-user-select');
            
            // حفظ القيمة المختارة حالياً
            const carVal = carS.value;
            const accVal = accS.value;

            carS.innerHTML = '<option value="">اختيار المستخدم</option>';
            accS.innerHTML = '<option value="">اختر المستخدم</option>';
            
            users.forEach(u => {
                carS.innerHTML += `<option value="${u.name}">${u.name}</option>`;
                accS.innerHTML += `<option value="${u.name}">${u.name}</option>`;
            });

            // استعادة القيمة
            if(carVal) carS.value = carVal;
            if(accVal) accS.value = accVal;
        }

        // --- إدارة المستخدمين ---
        window.saveUser = function() {
            const name = document.getElementById('new-username').value;
            const pass = document.getElementById('new-password').value;
            if(name) {
                const users = getDB(DB_KEYS.USERS);
                if(users.find(u => u.name === name)) {
                    alert("المستخدم موجود مسبقاً");
                    return;
                }
                users.push({ name, pass, id: Date.now() });
                setDB(DB_KEYS.USERS, users);
                
                document.getElementById('new-username').value = "";
                document.getElementById('new-password').value = "";
                populateUserDropdowns();
                renderUsersList();
                alert("تم إضافة المستخدم");
            } else {
                alert("يرجى كتابة الاسم");
            }
        };

        function renderUsersList() {
            const users = getDB(DB_KEYS.USERS);
            const container = document.getElementById('users-list-display');
            container.innerHTML = users.length ? users.map(u => 
                `<div class="bg-sky-50 p-2 rounded border border-sky-100 flex justify-between">
                    <span>${u.name}</span>
                    <button onclick="deleteUser(${u.id})" class="text-red-500 font-bold">X</button>
                 </div>`
            ).join('') : '<span class="text-gray-400 col-span-2">لا يوجد مستخدمين</span>';
        }

        window.deleteUser = (id) => {
            if(confirm("حذف المستخدم؟")) {
                let users = getDB(DB_KEYS.USERS);
                users = users.filter(u => u.id !== id);
                setDB(DB_KEYS.USERS, users);
                populateUserDropdowns();
                renderUsersList();
            }
        };

        // --- إدارة الحسابات ---
        window.addTransaction = function() {
            const user = document.getElementById('acc-user-select').value;
            const desc = document.getElementById('acc-desc').value;
            const forAmt = parseFloat(document.getElementById('acc-for').value) || 0;
            const againstAmt = parseFloat(document.getElementById('acc-against').value) || 0;
            
            if(!user || !desc) return alert("اختر المستخدم واكتب التفاصيل");
            
            const accounts = getDB(DB_KEYS.ACCOUNTS);
            accounts.push({
                id: Date.now(),
                user, desc, for: forAmt, against: againstAmt,
                date: new Date().toISOString().split('T')[0],
                timestamp: Date.now()
            });
            setDB(DB_KEYS.ACCOUNTS, accounts);

            document.getElementById('acc-desc').value = "";
            document.getElementById('acc-for').value = "";
            document.getElementById('acc-against').value = "";
            
            fetchAccountStatement();
        };

        window.fetchAccountStatement = function() {
            const user = document.getElementById('acc-user-select').value;
            const tbody = document.getElementById('statement-body');
            tbody.innerHTML = "";
            
            if(!user) {
                document.getElementById('total-for').innerText = 0;
                document.getElementById('total-against').innerText = 0;
                document.getElementById('net-balance').innerText = 0;
                return;
            }

            const allAccounts = getDB(DB_KEYS.ACCOUNTS);
            const userAccounts = allAccounts.filter(a => a.user === user).sort((a,b) => a.timestamp - b.timestamp);

            let tFor = 0, tAgainst = 0, balance = 0;
            
            userAccounts.forEach(item => {
                tFor += item.for; 
                tAgainst += item.against; 
                balance = tFor - tAgainst;
                tbody.innerHTML += `<tr><td>${item.date}</td><td>${item.desc}</td><td class="text-red-600">${item.against}</td><td class="text-green-600">${item.for}</td><td>${balance}</td></tr>`;
            });

            document.getElementById('total-for').innerText = tFor;
            document.getElementById('total-against').innerText = tAgainst;
            document.getElementById('net-balance').innerText = balance + " د.ع";
        };

        window.clearUserAccount = function() {
            const user = document.getElementById('acc-user-select').value;
            if(!user || !confirm("هل أنت متأكد من حذف سجل حسابات هذا المستخدم؟ لا يمكن التراجع.")) return;
            
            let accounts = getDB(DB_KEYS.ACCOUNTS);
            accounts = accounts.filter(a => a.user !== user); // إبقاء حسابات المستخدمين الآخرين فقط
            setDB(DB_KEYS.ACCOUNTS, accounts);
            
            fetchAccountStatement();
        };

        // --- إدارة السيارات ---
        window.handleFileSelect = async (e) => {
            // ملاحظة:LocalStorage لديه مساحة محدودة (حوالي 5-10MB).
            // نستخدم Compressor لضغط الصور بشدة.
            for(let f of e.target.files) {
                try {
                    const compressed = await new Promise((resolve, reject) => {
                        new Compressor(f, { 
                            quality: 0.2, 
                            maxWidth: 500, 
                            success(r){ resolve(r); },
                            error(err){ reject(err); }
                        });
                    });
                    
                    const reader = new FileReader();
                    reader.onloadend = () => { 
                        selectedImagesBase64.push(reader.result); 
                        renderPreviews(); 
                    };
                    reader.readAsDataURL(compressed);
                } catch(e) {
                    alert("خطأ في معالجة الصورة");
                }
            }
        };

        function renderPreviews() {
            document.getElementById('image-previews').innerHTML = selectedImagesBase64.map((img, i) => 
                `<div class="preview-container"><img src="${img}" class="w-full h-full object-cover"><div class="delete-preview" onclick="removePreview(${i})">X</div></div>`
            ).join('');
        }
        
        window.removePreview = (i) => { selectedImagesBase64.splice(i, 1); renderPreviews(); };

        window.openAddCarMode = () => {
            if(!document.getElementById('car-user-select').value) return alert("اختار المستخدم");
            window.editingCarId = null; 
            selectedImagesBase64 = []; 
            renderPreviews(); 
            clearCarInputs();
            document.getElementById('car-form-box').classList.remove('hidden');
            document.getElementById('delete-car-btn').classList.add('hidden');
        };

        window.closeCarForm = () => { document.getElementById('car-form-box').classList.add('hidden'); };
        
        function clearCarInputs(){ 
            ["car-name","car-type","car-model","car-chassis","car-container","car-lot","car-facade","car-arrival","car-shipping","car-notes"].forEach(id => document.getElementById(id).value = ""); 
        }

        window.saveCarWithPhotos = function() {
            const user = document.getElementById('car-user-select').value;
            if(!user) return;

            const payload = { 
                carName: document.getElementById('car-name').value, 
                type: document.getElementById('car-type').value, 
                model: document.getElementById('car-model').value, 
                chassis: document.getElementById('car-chassis').value, 
                container: document.getElementById('car-container').value, 
                lot: document.getElementById('car-lot').value, 
                facade: document.getElementById('car-facade').value, 
                arrival: document.getElementById('car-arrival').value, 
                shipping: document.getElementById('car-shipping').value, 
                notes: document.getElementById('car-notes').value, 
                user, 
                imageUrls: selectedImagesBase64, 
                updatedAt: Date.now() 
            };

            let cars = getDB(DB_KEYS.CARS);

            if(window.editingCarId) {
                // تعديل
                cars = cars.map(c => c.id === window.editingCarId ? { ...c, ...payload } : c);
            } else {
                // جديد
                payload.id = Date.now().toString();
                payload.createdAt = Date.now();
                cars.push(payload);
            }

            try {
                setDB(DB_KEYS.CARS, cars);
                closeCarForm();
                renderUserCarsGrid(user);
            } catch (e) {
                alert("ذاكرة المتصفح ممتلئة! حاول تقليل عدد الصور.");
            }
        };

        window.renderUserCarsGrid = function(user) {
            const grid = document.getElementById("user-cars-grid");
            if(!user) {
                grid.innerHTML = '<div class="text-gray-500 italic">اختر مستخدم</div>';
                return;
            }
            
            const allCars = getDB(DB_KEYS.CARS);
            const cars = allCars.filter(c => c.user === user);
            
            grid.innerHTML = cars.length ? cars.map(car => 
                `<button onclick="openEditCar('${car.id}')" class="text-right glass-card rounded-2xl p-3 flex gap-3 items-center">
                    <div class="w-16 h-16 rounded-xl border border-yellow-300 overflow-hidden bg-gray-100">
                        <img src="${car.imageUrls[0] || ''}" class="w-full h-full object-cover" onerror="this.src='https://placehold.co/100?text=Car'">
                    </div>
                    <div class="flex-1">
                        <div class="font-bold text-sky-900 text-sm">${car.carName || 'سيارة'}</div>
                        <div class="text-xs text-gray-500">${car.model || car.type || ''}</div>
                    </div>
                </button>`
            ).join('') : '<div class="text-gray-500 italic">لا توجد سيارات</div>';
        };

        window.openEditCar = (id) => {
            const allCars = getDB(DB_KEYS.CARS);
            const car = allCars.find(c => c.id === id);
            if(!car) return;

            window.editingCarId = id; 
            selectedImagesBase64 = [...(car.imageUrls || [])]; 
            renderPreviews();
            
            ["car-name","car-type","car-model","car-chassis","car-container","car-lot","car-facade","car-arrival","car-shipping","car-notes"].forEach(field => {
                const key = field.replace('car-', '');
                document.getElementById(field).value = car[key] || car[field] || "";
            });
            
            document.getElementById('car-form-box').classList.remove('hidden');
            document.getElementById('delete-car-btn').classList.remove('hidden');
        };

        window.deleteCurrentCar = () => {
            if(!window.editingCarId || !confirm("حذف هذه السيارة؟")) return;
            
            let cars = getDB(DB_KEYS.CARS);
            cars = cars.filter(c => c.id !== window.editingCarId);
            setDB(DB_KEYS.CARS, cars);
            
            closeCarForm();
            renderUserCarsGrid(document.getElementById('car-user-select').value);
        };

        window.resetAllData = () => {
            if(confirm("تحذير: هذا سيحذف جميع المستخدمين والسيارات والحسابات من هذا المتصفح. هل أنت متأكد؟")) {
                localStorage.clear();
                location.reload();
            }
        };

        // التشغيل عند الفتح
        loadInitialData();
    </script>
</body>
</html>

