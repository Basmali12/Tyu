
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>إدارة شركة احمد فوزي حسن</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/compressorjs/1.2.1/compressor.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/vanilla-tilt/1.8.1/vanilla-tilt.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        body { font-family: 'Cairo', sans-serif; background: #f0f9ff; color: #1e3a8a; }
        .glass-card { background: white; border: 2px solid #FFD700; box-shadow: 0 10px 25px rgba(0,0,0,0.05); }
        .tab-btn { color: #64748b; border-bottom: 3px solid transparent; transition: 0.3s; }
        .tab-active { background-color: #f0f9ff !important; color: #DAA520 !important; border-bottom: 3px solid #DAA520; }
        input, select, textarea { background: #ffffff !important; border: 1px solid #bae6fd !important; width: 100%; padding: 12px; border-radius: 12px; outline: none; margin-bottom: 10px; }
        .gold-bg { background: linear-gradient(to right, #FFD700, #DAA520); color: #1e3a8a; }
        .red-bg { background: #ea0038; color: white; }
        .hidden-tab { display: none; }
        .preview-container { position: relative; aspect-ratio: 1/1; border-radius: 10px; border: 1px solid #FFD700; overflow: hidden; }
        .delete-preview { position: absolute; top: 4px; right: 4px; background: #ea0038; color: white; width: 20px; height: 20px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 10px; cursor: pointer; }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">

    <div id="login-screen" class="w-full max-w-md glass-card rounded-[2rem] p-8 text-center" data-tilt>
        <img src="https://f.top4top.io/p_36418598n1.png" class="w-24 h-24 mx-auto mb-4">
        <h1 class="text-xl font-bold text-sky-800">لوحة تحكم المدير</h1>
        <p class="text-gold-600 text-xs mb-6">شركة احمد فوزي حسن</p>
        <input type="text" id="username" placeholder="اسم المستخدم">
        <input type="password" id="password" placeholder="كلمة المرور">
        <button onclick="btnFlip(this); login()" class="w-full gold-bg font-bold py-3 rounded-xl mt-4">دخول</button>
    </div>

    <div id="admin-panel" class="w-full max-w-2xl hidden flex flex-col gap-6 py-4">
        <div class="flex justify-between items-center px-4 glass-card p-4 rounded-2xl" data-tilt>
            <h1 class="text-sm font-bold text-sky-900">الإدارة - احمد فوزي حسن</h1>
            <button onclick="btnFlip(this); logout()" class="text-red-600 font-bold text-sm">خروج</button>
        </div>

        <div class="bg-white p-1 rounded-2xl flex gap-1 border border-sky-100 overflow-x-auto">
            <button onclick="btnFlip(this); switchTab('accounts')" id="tab-accounts" class="tab-btn flex-1 py-3 px-4 rounded-xl font-bold tab-active">إدارة الحسابات</button>
            <button onclick="btnFlip(this); switchTab('users')" id="tab-users" class="tab-btn flex-1 py-3 px-4 rounded-xl font-bold">إدارة المستخدمين</button>
            <button onclick="btnFlip(this); switchTab('cars')" id="tab-cars" class="tab-btn flex-1 py-3 px-4 rounded-xl font-bold">إدارة السيارات</button>
        </div>

        <div id="content-accounts" class="glass-card rounded-[2rem] p-8">
            <h2 class="text-center text-sky-800 mb-6 font-bold">إدارة حسابات الزبائن</h2>
            <select id="acc-user-select"><option>اختر المستخدم</option></select>

            <input type="number" id="acc-amount" placeholder="له (كم بقى له)">
            <input type="number" id="acc-amount2" placeholder="عليه (كم بقى عليه)">

            <input type="text" id="acc-desc" placeholder="الوصف">
            <div class="grid grid-cols-2 gap-4">
                <button class="gold-bg font-bold py-4 rounded-xl">له</button>
                <button class="red-bg font-bold py-4 rounded-xl">عليه</button>
            </div>
        </div>

        <div id="content-users" class="glass-card rounded-[2rem] p-8 hidden-tab">
            <h2 class="text-center text-sky-800 mb-6 font-bold">إضافة مستخدم جديد</h2>
            <input type="text" id="new-username" placeholder="اسم المستخدم الجديد">
            <input type="password" id="new-password" placeholder="كلمة المرور">
            <button onclick="btnFlip(this); saveUser()" class="gold-bg font-bold py-4 rounded-xl w-full">إنشاء الحساب</button>
        </div>

        <!-- ✅✅✅ التعديل فقط داخل قسم السيارات -->
        <div id="content-cars" class="glass-card rounded-[2rem] p-8 hidden-tab">
            <h2 class="text-center text-sky-800 mb-6 font-bold">إدارة سيارات المستخدم</h2>

            <!-- اختيار المستخدم + زر جلب السيارات -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
                <select id="car-user-select" class="md:col-span-2">
                    <option value="">اختيار المستخدم</option>
                </select>

                <button onclick="btnFlip(this); openAddCarMode()" class="gold-bg font-bold py-3 rounded-xl md:col-span-2">
                    + إضافة سيارة جديدة لهذا المستخدم
                </button>

                <!-- قائمة سيارات المستخدم (بطاقات) -->
                <div class="md:col-span-2 mt-2">
                    <div class="font-bold text-sky-900 mb-2">سيارات المستخدم</div>
                    <div id="user-cars-grid" class="grid grid-cols-1 md:grid-cols-2 gap-3">
                        <div class="text-gray-500 italic">اختر مستخدم حتى تظهر سياراته</div>
                    </div>
                </div>
            </div>

            <!-- نموذج إضافة/تعديل سيارة -->
            <div id="car-form-box" class="mt-6 border border-sky-100 rounded-2xl p-4 bg-sky-50 hidden">
                <div class="flex items-center justify-between mb-2">
                    <div id="car-form-title" class="font-bold text-sky-900">إضافة سيارة جديدة</div>
                    <button onclick="closeCarForm()" class="text-red-600 font-bold text-sm">إغلاق</button>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
                    <input type="text" id="car-name" placeholder="اسم السيارة (يظهر للمستخدم)">

                    <input type="text" id="car-type" placeholder="نوع السيارة">
                    <input type="text" id="car-model" placeholder="موديل السيارة">

                    <input type="text" id="car-chassis" placeholder="رقم الشاصي">
                    <input type="text" id="car-container" placeholder="رقم الحاوية">

                    <input type="text" id="car-lot" placeholder="رقم اللوت">
                    <input type="text" id="car-facade" placeholder="واجهة السيارة">

                    <input type="date" id="car-arrival">
                    <textarea id="car-shipping" placeholder="تفاصيل الشحن" class="md:col-span-2" rows="3"></textarea>

                    <input type="text" id="car-notes" placeholder="ملاحظات" class="md:col-span-2">

                    <input type="file" id="car-photos" multiple accept="image/*" onchange="handleFileSelect(event)" class="md:col-span-2">
                    <div id="image-previews" class="grid grid-cols-3 gap-3 md:col-span-2"></div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-2 mt-3">
                    <button id="save-car-btn" onclick="btnFlip(this); saveCarWithPhotos()" class="gold-bg font-bold py-3 rounded-xl md:col-span-2">
                        حفظ
                    </button>
                    <button id="delete-car-btn" onclick="btnFlip(this); deleteCurrentCar()" class="red-bg font-bold py-3 rounded-xl hidden">
                        حذف السيارة
                    </button>
                </div>

                <button id="download-all-btn" onclick="btnFlip(this); downloadAllCarImages()" class="mt-3 w-full border border-yellow-300 bg-white font-bold py-3 rounded-xl hidden">
                    تحميل الصور دفعة واحدة
                </button>

                <div class="text-xs text-gray-600 mt-2">
                    * “تحميل الصور دفعة واحدة” ينزّل كل صورة بتحميل مستقل تلقائياً (بدون zip).
                </div>
            </div>
        </div>
        <!-- ✅✅✅ نهاية التعديل -->

        <div class="glass-card rounded-[2rem] p-6 mb-10 text-center">
            <h3 id="summary-title" class="font-bold mb-4 text-sky-900">السجلات الحالية</h3>
            <div id="list-container" class="text-sm text-gray-500 italic">جاري التحميل...</div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js";
        import { getFirestore, collection, addDoc, deleteDoc, doc, onSnapshot, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBYp2NDXCuWUUn6SkYZZUg5gdw7RV8Keps",
            authDomain: "hbmar11111.firebaseapp.com",
            projectId: "hbmar11111",
            storageBucket: "hbmar11111.firebasestorage.app",
            messagingSenderId: "3682727892",
            appId: "1:3682727892:web:08a5f8de60a0a71cb3c841"
        };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        let selectedImagesBase64 = [];
        window.allCars = [];

        // ✅ حالة التعديل
        window.editingCarId = null;

        VanillaTilt.init(document.querySelectorAll("[data-tilt]"), { max: 5 });
        window.btnFlip = (el) => gsap.to(el, { duration: 0.5, rotationY: 360 });

        window.login = () => {
            if(document.getElementById('username').value === 'bilal' && document.getElementById('password').value === '198912') {
                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('admin-panel').classList.remove('hidden');
                document.body.classList.replace('items-center', 'items-start');
                loadInitialData();
            } else {
                alert("بيانات الدخول غير صحيحة");
            }
        };

        window.switchTab = (tab) => {
            ['content-accounts', 'content-users', 'content-cars'].forEach(id => document.getElementById(id).classList.add('hidden-tab'));
            document.getElementById('content-' + tab).classList.remove('hidden-tab');

            ['accounts','users','cars'].forEach(t => document.getElementById('tab-' + t).classList.remove('tab-active'));
            document.getElementById('tab-' + tab).classList.add('tab-active');

            // عرض قائمة عامة مثل قبل (خليتها)
            if(tab === "cars") renderList('cars');
        };

        window.saveUser = async function() {
            const name = document.getElementById('new-username').value;
            const pass = document.getElementById('new-password').value;
            if(name && pass) {
                await addDoc(collection(db, "users"), { name, pass });
                alert("تم الإنشاء");
            }
        };

        // ضغط + تحويل base64 للصور
        window.handleFileSelect = async (e) => {
            const files = e.target.files;
            for(let f of files) {
                const compressed = await new Promise(res => new Compressor(f, { quality: 0.2, maxWidth: 600, success(r){res(r)} }));
                const reader = new FileReader();
                reader.onloadend = () => {
                    selectedImagesBase64.push(reader.result);
                    renderPreviews();
                };
                reader.readAsDataURL(compressed);
            }
        };

        function renderPreviews() {
            document.getElementById('image-previews').innerHTML = selectedImagesBase64
                .map((img, i) => `<div class="preview-container">
                    <img src="${img}">
                    <div class="delete-preview" onclick="removePreview(${i})">X</div>
                </div>`).join('');
        }

        window.removePreview = (i) => {
            selectedImagesBase64.splice(i, 1);
            renderPreviews();
        };

        // ✅ فتح وضع إضافة
        window.openAddCarMode = () => {
            const user = document.getElementById('car-user-select').value;
            if(!user) return alert("اختار المستخدم أولاً");

            window.editingCarId = null;
            selectedImagesBase64 = [];
            renderPreviews();
            clearCarInputs();

            document.getElementById('car-form-title').textContent = "إضافة سيارة جديدة";
            document.getElementById('car-form-box').classList.remove('hidden');
            document.getElementById('delete-car-btn').classList.add('hidden');
            document.getElementById('download-all-btn').classList.add('hidden');
        };

        window.closeCarForm = () => {
            document.getElementById('car-form-box').classList.add('hidden');
            window.editingCarId = null;
        };

        function clearCarInputs(){
            const ids = ["car-name","car-type","car-model","car-chassis","car-container","car-lot","car-facade","car-arrival","car-shipping","car-notes"];
            ids.forEach(id => document.getElementById(id).value = "");
            document.getElementById("car-photos").value = "";
        }

        // ✅ حفظ: إذا إضافة -> addDoc | إذا تعديل -> updateDoc
        window.saveCarWithPhotos = async function() {
            const user = document.getElementById('car-user-select').value;
            if(!user) return alert("اختار المستخدم أولاً");

            const payload = {
                carName: document.getElementById('car-name').value,
                type: document.getElementById('car-type').value,
                model: document.getElementById('car-model').value,
                chassis: document.getElementById('car-chassis').value,
                container: document.getElementById('car-container').value,
                lot: document.getElementById('car-lot').value,
                facade: document.getElementById('car-facade').value,
                arrival: document.getElementById('car-arrival').value,
                shipping: document.getElementById('car-shipping').value,
                notes: document.getElementById('car-notes').value,
                user,
                imageUrls: selectedImagesBase64,
                updatedAt: Date.now()
            };

            if(window.editingCarId){
                await updateDoc(doc(db, "cars", window.editingCarId), payload);
                alert("تم التعديل");
            } else {
                payload.createdAt = Date.now();
                await addDoc(collection(db, "cars"), payload);
                alert("تم الحفظ");
            }

            // تحديث عرض سيارات المستخدم بعد الحفظ
            closeCarForm();
        };

        // ✅ حذف سيارة مختارة
        window.deleteCurrentCar = async function(){
            if(!window.editingCarId) return;
            if(!confirm("تحذف السيارة نهائياً؟")) return;
            await deleteDoc(doc(db, "cars", window.editingCarId));
            alert("تم الحذف");
            closeCarForm();
        };

        // ✅ تنزيل كل صور السيارة (دفعة وحدة = تنزيلات متعددة)
        window.downloadAllCarImages = function(){
            if(!window.editingCarId) return;

            const car = (window.allCars || []).find(c => c.id === window.editingCarId);
            if(!car || !car.imageUrls || !car.imageUrls.length) return alert("ماكو صور لهذه السيارة");

            car.imageUrls.forEach((dataUrl, idx) => {
                const a = document.createElement("a");
                a.href = dataUrl;
                a.download = `${(car.carName || car.type || "car")}_${idx+1}.jpg`;
                document.body.appendChild(a);
                a.click();
                a.remove();
            });
        };

        // ✅ بطاقة سيارة للمستخدم: اسم + صورة معاينة + فتح
        function renderUserCarsGrid(user){
            const grid = document.getElementById("user-cars-grid");
            const cars = (window.allCars || []).filter(c => c.user === user);

            if(!cars.length){
                grid.innerHTML = `<div class="text-gray-500 italic md:col-span-2">لا توجد سيارات لهذا المستخدم</div>`;
                return;
            }

            grid.innerHTML = cars.map(car => {
                const cover = (car.imageUrls && car.imageUrls[0]) ? car.imageUrls[0] : "";
                return `
                    <button onclick="openEditCar('${car.id}')" class="text-right glass-card rounded-2xl p-3 hover:scale-[1.01] transition">
                        <div class="flex gap-3 items-center">
                            <div class="w-16 h-16 rounded-xl border border-yellow-300 overflow-hidden bg-white flex items-center justify-center">
                                ${cover ? `<img src="${cover}" class="w-full h-full object-cover">` : `<i class="fa-solid fa-car text-sky-500 text-xl"></i>`}
                            </div>
                            <div class="flex-1">
                                <div class="font-bold text-sky-900">${car.carName || (car.type || "سيارة")}</div>
                                <div class="text-xs text-gray-600">${car.type || "-"} • ${car.model || "-"}</div>
                            </div>
                            <div class="text-xs text-yellow-700 font-bold">فتح</div>
                        </div>
                    </button>
                `;
            }).join('');
        }

        // ✅ فتح السيارة للتعديل داخل الفورم
        window.openEditCar = function(carId){
            const car = (window.allCars || []).find(c => c.id === carId);
            if(!car) return;

            window.editingCarId = carId;
            selectedImagesBase64 = Array.isArray(car.imageUrls) ? [...car.imageUrls] : [];
            renderPreviews();

            document.getElementById('car-form-title').textContent = "تعديل سيارة";
            document.getElementById('car-form-box').classList.remove('hidden');

            document.getElementById('car-name').value = car.carName || "";
            document.getElementById('car-type').value = car.type || "";
            document.getElementById('car-model').value = car.model || "";
            document.getElementById('car-chassis').value = car.chassis || "";
            document.getElementById('car-container').value = car.container || "";
            document.getElementById('car-lot').value = car.lot || "";
            document.getElementById('car-facade').value = car.facade || "";
            document.getElementById('car-arrival').value = car.arrival || "";
            document.getElementById('car-shipping').value = car.shipping || "";
            document.getElementById('car-notes').value = car.notes || "";

            document.getElementById('delete-car-btn').classList.remove('hidden');
            document.getElementById('download-all-btn').classList.toggle('hidden', !(selectedImagesBase64 && selectedImagesBase64.length));
        };

        // ✅ listeners + تحميل الداتا
        function loadInitialData() {
            onSnapshot(collection(db, "users"), (snap) => {
                const select = document.getElementById('car-user-select');
                select.innerHTML = '<option value="">اختيار المستخدم</option>';
                snap.forEach(d => {
                    const u = d.data();
                    select.innerHTML += `<option value="${u.name}">${u.name}</option>`;
                });

                // عند تغيير المستخدم: عرض سياراته
                select.onchange = () => {
                    const user = select.value;
                    closeCarForm();
                    if(user) renderUserCarsGrid(user);
                    else document.getElementById("user-cars-grid").innerHTML = `<div class="text-gray-500 italic">اختر مستخدم حتى تظهر سياراته</div>`;
                };
            });

            onSnapshot(collection(db, "cars"), (snap) => {
                const cars = [];
                snap.forEach(d => cars.push({ id: d.id, ...d.data() }));
                window.allCars = cars;

                // إذا مختار مستخدم حالياً، حدث العرض
                const user = document.getElementById('car-user-select')?.value;
                if(user) renderUserCarsGrid(user);

                // القائمة العامة القديمة
                renderList('cars');
            });
        }

        function renderList(tab) {
            document.getElementById('list-container').innerHTML = (window.allCars || [])
                .map(item => `<div class="flex justify-between p-2 border-b"><span>${item.type || "-"}</span></div>`)
                .join('');
        }

        window.logout = () => location.reload();
    </script>
</body>
</html>
